<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP AI 助手</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #e9eff5; display: flex; justify-content: center; height: 100vh; margin: 0; }
        .chat-container { width: 100%; max-width: 700px; background: white; height: 95vh; margin-top: 10px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .header { background: linear-gradient(135deg, #3e4d8c 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 1.2em;}
        .messages-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background-color: #f8f9fa;}
        .message { padding: 12px 18px; border-radius: 18px; max-width: 80%; line-height: 1.6; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05);}
        .message.user { background-color: #3e4d8c; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .message.ai { background-color: white; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #eee;}
        .input-area { padding: 20px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        input { flex: 1; padding: 14px; border: 1px solid #ddd; border-radius: 25px; outline: none; font-size: 16px; transition: border-color 0.3s;}
        input:focus { border-color: #3e4d8c; }
        button { padding: 10px 25px; background: linear-gradient(135deg, #3e4d8c 0%, #764ba2 100%); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .loading { color: #3e4d8c; font-size: 14px; align-self: center; font-style: italic;}
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_URL = "http://localhost:8001/agent/chat";

        function App() {
            const [input, setInput] = useState("");
            const [messages, setMessages] = useState([
                { role: "ai", content: "你好!我是你的AI 助手。我可以查询天气和访问文件，也可以陪你聊天。" }
            ]);
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);
            
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const sendMessage = async () => {
                if (!input.trim()) return;
                const userMessage = { role: "user", content: input };
                setMessages(prev => [...prev, userMessage]); //使用 prev => [...] 而非直接传值。
                                                             //在闭包或快速连续更新场景下，这能确保基于最新的 prev 状态追加数据，防止旧状态覆盖新状态（Stale State）
                setInput("");
                setIsLoading(true);

                try {
                    // 发送请求到中间桥梁
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ prompt: input })
                    });

                    if (!response.ok) throw new Error("Network response was not ok");
                    const data = await response.json();
                    
                    setMessages(prev => [...prev, { role: "ai", content: data.response }]);
                } catch (error) {
                    console.error("Error:", error);
                    setMessages(prev => [...prev, { role: "ai", content: "⚠️ 连接失败，请检查 Agent API (端口8001) 和 MCP Server (端口8000) 是否都在运行。" }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="chat-container">
                    <div className="header">MCP AI Agent</div>
                    <div className="messages-box">
                        {messages.map((msg, index) => (
                            <div key={index} className={`message ${msg.role}`}>
                                {msg.content.split('\n').map((line, i) => <div key={i}>{line}</div>)}
                            </div>
                        ))}
                        {isLoading && <div className="loading">AI 正在通过 MCP 协议连接远程工具...</div>}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="input-area">
                        <input 
                            type="text" 
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                            placeholder="输入消息..." 
                            disabled={isLoading}
                        />
                        <button onClick={sendMessage} disabled={isLoading}>
                            {isLoading ? "..." : "发送"}
                        </button>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>